From 020f01ebd04f3429c32586d90598c9f59e54ca7d Mon Sep 17 00:00:00 2001
From: Joe Perches <joe@perches.com>
Date: Tue, 9 Nov 2010 14:35:16 +0000
Subject: [PATCH] drivers/isdn/mISDN: Use printf extension %pV

From mainline

Using %pV reduces the number of printk calls and
eliminates any possible message interleaving from
other printk calls.

Signed-off-by: Joe Perches <joe@perches.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
---
 drivers/isdn/mISDN/layer1.c |   10 +++++++---
 drivers/isdn/mISDN/layer2.c |   12 +++++++++---
 drivers/isdn/mISDN/tei.c    |   23 +++++++++++++++++------
 3 files changed, 33 insertions(+), 12 deletions(-)

Index: standalone/drivers/isdn/mISDN/layer1.c
===================================================================
--- standalone.orig/drivers/isdn/mISDN/layer1.c
+++ standalone/drivers/isdn/mISDN/layer1.c
@@ -101,16 +101,12 @@ static void
 l1m_debug(struct FsmInst *fi, char *fmt, ...)
 {
 	struct layer1 *l1 = fi->userdata;
-	struct va_format vaf;
 	va_list va;
 
 	va_start(va, fmt);
-
-	vaf.fmt = fmt;
-	vaf.va = &va;
-
-	printk(KERN_DEBUG "%s: %pV\n", dev_name(&l1->dch->dev.dev), &vaf);
-
+	printk(KERN_DEBUG "%s: ", dev_name(&l1->dch->dev.dev));
+	vprintk(fmt, va);
+	printk("\n");
 	va_end(va);
 }
 
Index: standalone/drivers/isdn/mISDN/layer2.c
===================================================================
--- standalone.orig/drivers/isdn/mISDN/layer2.c
+++ standalone/drivers/isdn/mISDN/layer2.c
@@ -99,20 +99,15 @@ static void
 l2m_debug(struct FsmInst *fi, char *fmt, ...)
 {
 	struct layer2 *l2 = fi->userdata;
-	struct va_format vaf;
 	va_list va;
 
 	if (!(*debug & DEBUG_L2_FSM))
 		return;
-
 	va_start(va, fmt);
-
-	vaf.fmt = fmt;
-	vaf.va = &va;
-
-	printk(KERN_DEBUG "%s l2 (sapi %d tei %d): %pV\n",
-	       mISDNDevName4ch(&l2->ch), l2->sapi, l2->tei, &vaf);
-
+	printk(KERN_DEBUG "%s l2 (sapi %d tei %d): ",
+		mISDNDevName4ch(&l2->ch), l2->sapi, l2->tei);
+	vprintk(fmt, va);
+	printk("\n");
 	va_end(va);
 }
 
Index: standalone/drivers/isdn/mISDN/tei.c
===================================================================
--- standalone.orig/drivers/isdn/mISDN/tei.c
+++ standalone/drivers/isdn/mISDN/tei.c
@@ -79,19 +79,14 @@ static void
 da_debug(struct FsmInst *fi, char *fmt, ...)
 {
 	struct manager	*mgr = fi->userdata;
-	struct va_format vaf;
 	va_list va;
 
 	if (!(*debug & DEBUG_L2_TEIFSM))
 		return;
-
 	va_start(va, fmt);
-
-	vaf.fmt = fmt;
-	vaf.va = &va;
-
-	printk(KERN_DEBUG "mgr(%d): %pV\n", mgr->ch.st->dev->id, &vaf);
-
+	printk(KERN_DEBUG "mgr(%d): ", mgr->ch.st->dev->id);
+	vprintk(fmt, va);
+	printk("\n");
 	va_end(va);
 }
 
@@ -228,20 +223,14 @@ static void
 tei_debug(struct FsmInst *fi, char *fmt, ...)
 {
 	struct teimgr	*tm = fi->userdata;
-	struct va_format vaf;
 	va_list va;
 
 	if (!(*debug & DEBUG_L2_TEIFSM))
 		return;
-
 	va_start(va, fmt);
-
-	vaf.fmt = fmt;
-	vaf.va = &va;
-
-	printk(KERN_DEBUG "sapi(%d) tei(%d): %pV\n",
-	       tm->l2->sapi, tm->l2->tei, &vaf);
-
+	printk(KERN_DEBUG "sapi(%d) tei(%d): ", tm->l2->sapi, tm->l2->tei);
+	vprintk(fmt, va);
+	printk("\n");
 	va_end(va);
 }
 
